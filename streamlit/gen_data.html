<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>톡톡 상담 ERD 데이터 생성 · 미리보기</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #222;
    }
    .app {
      max-width: 1200px; margin: 40px auto; padding: 0 16px 40px;
    }
    .header {
      background: #fff; border-radius: 16px; padding: 24px 28px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08); border: 1px solid #eee;
    }
    .title { font-size: 22px; font-weight: 800; margin: 0 0 4px; }
    .desc { color: #666; font-size: 14px; }

    .controls {
      display: grid; grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap: 16px; margin-top: 18px;
    }
    .control { display: flex; flex-direction: column; gap: 8px; }
    .control label { font-size: 13px; color: #555; }
    .control input {
      padding: 12px 12px; border: 2px solid #e9ecef; border-radius: 10px;
      font-size: 15px; outline: none;
    }
    .control input:focus { border-color: #667eea; }
    .actions { display: flex; align-items: center; gap: 10px; }

    .btn {
      padding: 12px 18px; border: none; border-radius: 10px;
      background: linear-gradient(135deg, #28a745, #20c997);
      color: #fff; font-weight: 700; cursor: pointer; transition: transform .15s ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn.secondary {
      background: #f1f3f5; color: #333; font-weight: 600;
      border: 1px solid #e9ecef;
    }

    .stats {
      margin-top: 18px; display: grid; gap: 14px;
      grid-template-columns: repeat(4, minmax(120px, 1fr));
    }
    .stat {
      background:#fff; border:1px solid #eee; border-radius: 14px; padding: 16px 18px;
      display:flex; flex-direction:column; gap:6px; text-align:center;
      transition: transform .2s ease;
    }
    .stat:hover { transform: translateY(-3px); }
    .stat .num { font-size: 26px; font-weight: 800; color:#4c6ef5; }
    .stat .label { font-size: 12px; color:#666; }

    .tabs {
      margin-top: 18px; display: flex; gap: 6px; overflow-x: auto;
      background: #f8f9fa; border: 1px solid #eee; border-radius: 12px; padding: 6px;
    }
    .tab {
      background:#fff; border:1px solid #e9ecef; color:#333; padding:10px 14px;
      border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 13px;
    }
    .tab.active { background:#4c6ef5; color:#fff; border-color:#4c6ef5; }

    .panel {
      margin-top: 14px; background:#fff; border:1px solid #eee; border-radius: 12px; padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    .panel h3 { margin: 6px 6px 12px; font-size: 16px; }

    .table-wrap { overflow:auto; border-radius: 10px; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { border:1px solid #f1f3f5; padding:8px 10px; white-space: nowrap; }
    th { background:#f8f9fa; text-align:left; position: sticky; top: 0; }

    .downloads { margin-top: 16px; display:flex; flex-wrap: wrap; gap:8px; }
    .dl-btn {
      padding: 10px 12px; border-radius: 10px; border:1px solid #e9ecef; background:#fff;
      cursor: pointer; font-size: 13px; font-weight: 700;
    }
    .dl-btn.all { background:#4c6ef5; color:#fff; border-color:#4c6ef5; }
    .footer { margin-top: 14px; color:#777; font-size: 12px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">톡톡 상담 ERD 데이터 생성 · 미리보기</div>
      <div class="desc">ERD 스키마(consultants, customers, consultations, fund_types, documents, M:N 브릿지, 로그)를 따르는 더미 데이터를 생성하고, 표로 확인·CSV로 내려받을 수 있어요.</div>

      <div class="controls">
        <div class="control">
          <label>상담사 수 (consultants)</label>
          <input id="nConsultants" type="number" min="1" max="1000" value="50"/>
        </div>
        <div class="control">
          <label>고객 수 (customers)</label>
          <input id="nCustomers" type="number" min="1" max="50000" value="5000"/>
        </div>
        <div class="control">
          <label>상담 수 (consultations)</label>
          <input id="nConsultations" type="number" min="1" max="50000" value="30000"/>
        </div>
        <div class="actions">
          <button class="btn" onclick="generateData()">데이터 생성</button>
          <button class="btn secondary" onclick="clearData()">초기화</button>
        </div>
      </div>

      <div class="stats">
        <div class="stat"><div class="num" id="sConsultants">0</div><div class="label">상담사</div></div>
        <div class="stat"><div class="num" id="sCustomers">0</div><div class="label">고객</div></div>
        <div class="stat"><div class="num" id="sConsultations">0</div><div class="label">상담</div></div>
        <div class="stat"><div class="num" id="sAvgSatisfaction">0.0</div><div class="label">평균 만족도</div></div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="consultations" onclick="switchTab(event,'consultations')">상담</div>
      <div class="tab" data-tab="consultants" onclick="switchTab(event,'consultants')">상담사</div>
      <div class="tab" data-tab="customers" onclick="switchTab(event,'customers')">고객</div>
      <div class="tab" data-tab="fund_types" onclick="switchTab(event,'fund_types')">자금유형</div>
      <div class="tab" data-tab="documents" onclick="switchTab(event,'documents')">서류</div>
      <div class="tab" data-tab="consultation_fund_types" onclick="switchTab(event,'consultation_fund_types')">상담-자금유형</div>
      <div class="tab" data-tab="consultation_documents" onclick="switchTab(event,'consultation_documents')">상담-서류</div>
      <div class="tab" data-tab="conversation_logs" onclick="switchTab(event,'conversation_logs')">상담로그</div>
    </div>

    <div class="panel">
      <div id="tableTitle"></div>
      <div class="table-wrap" id="tableWrap"><p style="padding:8px 6px;color:#777">데이터를 생성하면 표가 나타납니다.</p></div>

      <div class="downloads">
        <button class="dl-btn" onclick="downloadCSV('consultants')">👨‍💼 상담사</button>
        <button class="dl-btn" onclick="downloadCSV('customers')">👥 고객</button>
        <button class="dl-btn" onclick="downloadCSV('consultations')">💬 상담</button>
        <button class="dl-btn" onclick="downloadCSV('fund_types')">💰 자금유형</button>
        <button class="dl-btn" onclick="downloadCSV('documents')">📋 서류</button>
        <button class="dl-btn" onclick="downloadCSV('consultation_fund_types')">🔗 상담-자금유형</button>
        <button class="dl-btn" onclick="downloadCSV('consultation_documents')">🔎 상담-서류</button>
        <button class="dl-btn" onclick="downloadCSV('conversation_logs')">📝 상담로그</button>
        <button class="dl-btn all" onclick="downloadAll()">📦 전체 CSV</button>
      </div>
      <div class="footer">※ 표는 최대 200행만 미리보기로 보여줍니다. CSV에는 전체가 저장됩니다.</div>
    </div>
  </div>

  <script>
    // 전역 저장소 (테이블명은 DB 스키마와 동일하게 유지)
    const store = {
      consultants: [],
      customers: [],
      fund_types: [],
      documents: [],
      consultations: [],
      consultation_fund_types: [],
      consultation_documents: [],
      conversation_logs: []
    };

    // 샘플 사전 데이터
    const departments = ["정책자금", "소상공인", "민원상담", "일반상담", "전문상담"];
    const majors = ["경영학", "경제학", "정보보호", "데이터사이언스", "행정학", "통계학", "법학"];
    const teams = ["A팀", "B팀", "C팀"];
    const regions = ["서울", "경기", "인천", "부산", "대구", "광주", "대전", "울산", "강원", "충북", "충남", "전북", "전남", "경북", "경남", "제주"];
    const businessTypes = ["제조업","도소매","음식점","카페","생활서비스","IT서비스","교육서비스","운수업","출판/인쇄","농업"];
    const fundTypeNames = [
      "운전자금-매출채권담보", "운전자금-소상공인",
      "창업-초기창업", "창업-재창업", "스마트공장", "스마트기술", "일반형-백년가게",
      "일반형-사회적경제기업", "일반형-신사업사관학교"
    ];
    const documentNames = [
      "대출신청서","사업자등록증명","표준재무제표증명","납세증명서","지방세납세증명서",
      "건강보험가입자별부과현황","주민등록표등본","등기사항전부증명서","임대차계약서","사업계획서"
    ];
    const resolutionTypes = ["완료","보류","이관","반려"];
    const logTypes = ["생성","배정","서류요청","서류접수","검증","종료"];
    const statuses = ["진행중","완료","대기","보류"];
    const genders = ["남","여"];
    const r = (n)=>Math.floor(Math.random()*n);

    function randPick(arr){ return arr[r(arr.length)]; }
    function pad2(n){ return String(n).padStart(2,"0"); }
    
    // 주말 체크 함수
    function isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6; // 일요일(0) 또는 토요일(6)
    }
    
    // 근무시간 내 랜덤 시간 생성 (점심 후 가중치 적용)
    function getBusinessHour() {
      const weights = [
        // 9시-12시: 기본 가중치
        1, 1, 1, 1, // 9, 10, 11, 12시
        // 13시-15시: 점심 후 높은 가중치
        3, 3, 3, // 13, 14, 15시
        // 16시-17시: 기본 가중치
        1, 1 // 16, 17시
      ];
      
      const totalWeight = weights.reduce((sum, w) => sum + w, 0);
      let random = Math.random() * totalWeight;
      
      for (let i = 0; i < weights.length; i++) {
        random -= weights[i];
        if (random <= 0) {
          return 9 + i; // 9시부터 시작
        }
      }
      return 14; // 기본값 (점심 후)
    }
    
    // 근무일 내 랜덤 날짜/시간 생성
    function dateTimeBetweenBusiness(start, end) {
      let attempts = 0;
      const maxAttempts = 100;
      
      while (attempts < maxAttempts) {
        const s = new Date(start).getTime();
        const e = new Date(end).getTime();
        const t = s + Math.random() * (e - s);
        const randomDate = new Date(t);
        
        // 주말이 아닌 경우에만 진행
        if (!isWeekend(randomDate)) {
          // 근무시간 설정
          const hour = getBusinessHour();
          const minute = r(60);
          const second = r(60);
          
          randomDate.setHours(hour, minute, second);
          return randomDate;
        }
        attempts++;
      }
      
      // 만약 100번 시도해도 평일을 못 찾으면 강제로 평일 생성
      const s = new Date(start).getTime();
      const e = new Date(end).getTime();
      const t = s + Math.random() * (e - s);
      const fallbackDate = new Date(t);
      
      // 주말이면 다음 월요일로 변경
      while (isWeekend(fallbackDate)) {
        fallbackDate.setDate(fallbackDate.getDate() + 1);
      }
      
      const hour = getBusinessHour();
      const minute = r(60);
      const second = r(60);
      fallbackDate.setHours(hour, minute, second);
      
      return fallbackDate;
    }
    
    function dateBetween(start, end){
      const s = new Date(start).getTime();
      const e = new Date(end).getTime();
      const t = s + Math.random()*(e-s);
      return new Date(t);
    }
    
    function fmtDate(d){
      const y=d.getFullYear(), m=pad2(d.getMonth()+1), day=pad2(d.getDate());
      return `${y}-${m}-${day}`;
    }
    function fmtDateTime(d){
      const y=d.getFullYear(), m=pad2(d.getMonth()+1), day=pad2(d.getDate());
      const hh=pad2(d.getHours()), mm=pad2(d.getMinutes()), ss=pad2(d.getSeconds());
      return `${y}-${m}-${day} ${hh}:${mm}:${ss}`;
    }
    function phone(){
      return `010-${pad2(r(90)+10)}${pad2(r(10))}-${pad2(r(90)+10)}${pad2(r(10))}`;
    }
    function nameKR(){
      const s = ["김","이","박","최","정","강","조","윤","장","임","한","오","서","신","권","황","안","송","류","전"];
      const g = ["민수","영희","철수","영수","지민","지연","도현","유나","성민","하은","서준","서연","지우","현우","서현","연우","준호","지영","동현","수진"];
      return s[r(s.length)] + g[r(g.length)];
    }

    function clearData(){
      Object.keys(store).forEach(k => store[k] = []);
      updateStats();
      renderTable("consultations");
    }

    function generateData(){
      clearData();
      const nCns = parseInt(document.getElementById("nConsultants").value || "50", 10);
      const nCus = parseInt(document.getElementById("nCustomers").value || "5000", 10);
      const nCon = parseInt(document.getElementById("nConsultations").value || "30000", 10);

      console.log("데이터 생성 시작:", nCns, "상담사,", nCus, "고객,", nCon, "상담");

      // consultants
      for(let i=1;i<=nCns;i++){
        const join = dateBetween("2022-01-01","2025-08-01");
        store.consultants.push({
          consultant_id: i,
          name: nameKR(),
          department: randPick(departments),
          major: randPick(majors),
          join_date: fmtDate(join),
          team: randPick(teams)
        });
      }

      // customers
      for(let i=1;i<=nCus;i++){
        store.customers.push({
          customer_id: i,
          age: 20 + r(41),
          gender: randPick(genders),
          name: nameKR(),
          region: randPick(regions),
          phone_number: phone(),
          business_type: randPick(businessTypes)
        });
      }

      // fund_types
      for(let i=1;i<=fundTypeNames.length;i++){
        store.fund_types.push({
          fund_type_id: i,
          fund_type_name: fundTypeNames[i-1]
        });
      }

      // documents
      for(let i=1;i<=documentNames.length;i++){
        const req = Math.random()<0.7;
        const sub = req ? Math.random()<0.6 : false;
        store.documents.push({
          document_id: i,
          document_name: documentNames[i-1],
          is_required: req,
          is_submitted: sub,
          submission_date: sub ? fmtDate(dateBetween("2025-01-01","2025-08-25")) : null
        });
      }

      // consultations + bridges + logs (6개월 이상 데이터 생성)
      console.log("상담 데이터 생성 중...");
      for(let i=1;i<=nCon;i++){
        const consultant_id = r(nCns)+1;
        const customer_id = r(nCus)+1;
        
        // 근무시간 내 시작 시간 생성 (6개월 이상 기간으로 확장)
        const start = dateTimeBetweenBusiness("2025-01-01","2025-08-25");
        const durMin = 5 + r(40); // 5~45분
        const end = new Date(start.getTime() + durMin*60*1000);
        const satisfaction = 3 + r(3); // 3~5점 위주

        store.consultations.push({
          consultation_id: i,
          consultant_id, customer_id,
          start_time: fmtDateTime(start),
          end_time: fmtDateTime(end),
          consultation_date: fmtDate(start),
          resolution_type: randPick(resolutionTypes),
          satisfaction_score: satisfaction
        });

        // 상담-자금유형 (1~2개 후보)
        const fundCount = 1 + r(2);
        const chosen = new Set();
        for(let k=0;k<fundCount;k++){
          const ft = r(store.fund_types.length)+1;
          if(chosen.has(ft)) continue;
          chosen.add(ft);
          store.consultation_fund_types.push({
            consultation_id: i,
            fund_type_id: ft
          });
        }

        // 상담-서류 (2~5개 요구)
        const docCount = 2 + r(4);
        const chosenDoc = new Set();
        for(let k=0;k<docCount;k++){
          const d = r(store.documents.length)+1;
          if(chosenDoc.has(d)) continue;
          chosenDoc.add(d);
          store.consultation_documents.push({
            consultation_id: i,
            document_id: d
          });
        }

        // 상담로그 (3~8개)
        const logCnt = 3 + r(6);
        for(let k=1;k<=logCnt;k++){
          const logTime = dateTimeBetweenBusiness(start, end);
          store.conversation_logs.push({
            log_id: (i-1)*8 + k,
            consultation_id: i,
            timestamp: fmtDateTime(logTime),
            log_type: randPick(logTypes),
            status: randPick(statuses),
            created_at: fmtDateTime(new Date())
          });
        }

        // 진행상황 표시 (대량 데이터 생성시)
        if (i % 1000 === 0) {
          console.log(`${i}/${nCon} 상담 생성 완료`);
        }
      }

      console.log("데이터 생성 완료");
      updateStats();
      renderTable(getActiveTab());
    }

    function updateStats(){
      const avgSat = store.consultations.length
        ? (store.consultations.reduce((s,c)=>s+(c.satisfaction_score||0),0) / store.consultations.length).toFixed(1)
        : "0.0";
      document.getElementById("sConsultants").textContent = store.consultants.length.toLocaleString();
      document.getElementById("sCustomers").textContent = store.customers.length.toLocaleString();
      document.getElementById("sConsultations").textContent = store.consultations.length.toLocaleString();
      document.getElementById("sAvgSatisfaction").textContent = avgSat;
    }

    function getActiveTab(){
      const active = document.querySelector(".tab.active");
      return active ? active.dataset.tab : "consultations";
    }
    function switchTab(e, name){
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      e.target.classList.add("active");
      renderTable(name);
    }

    function renderTable(name){
      const wrap = document.getElementById("tableWrap");
      const titleEl = document.getElementById("tableTitle");
      let data = [];
      let title = "";
      switch(name){
        case "consultations": data = store.consultations; title="💬 상담 (consultations)"; break;
        case "consultants": data = store.consultants; title="👨‍💼 상담사 (consultants)"; break;
        case "customers": data = store.customers; title="👥 고객 (customers)"; break;
        case "fund_types": data = store.fund_types; title="💰 자금유형 (fund_types)"; break;
        case "documents": data = store.documents; title="📋 서류 (documents)"; break;
        case "consultation_fund_types": data = store.consultation_fund_types; title="🔗 상담-자금유형"; break;
        case "consultation_documents": data = store.consultation_documents; title="🔎 상담-서류"; break;
        case "conversation_logs": data = store.conversation_logs; title="📝 상담로그"; break;
      }
      titleEl.innerHTML = `<h3>${title} <small style="color:#777;font-weight:600">(${data.length.toLocaleString()} rows)</small></h3>`;
      if(!data || data.length===0){
        wrap.innerHTML = `<p style="padding:8px 6px;color:#777">데이터가 없습니다. 상단의 "데이터 생성"을 눌러주세요.</p>`;
        return;
      }
      const headers = Object.keys(data[0]);
      const rows = data.slice(0,200).map(row =>
        `<tr>${headers.map(h=>`<td>${row[h]!==undefined && row[h]!==null ? String(row[h]).replace(/&/g,"&amp;").replace(/</g,"&lt;") : ""}</td>`).join("")}</tr>`
      ).join("");
      wrap.innerHTML = `<div class="table-wrap"><table>
        <thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead>
        <tbody>${rows}</tbody>
      </table></div>`;
    }

    // CSV
    function toCSV(arr){
      if(!arr || arr.length===0) return "";
      const headers = Object.keys(arr[0]);
      const esc = v => {
        const s = (v===undefined || v===null) ? "" : String(v);
        if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      };
      const lines = [headers.join(",")];
      for(const row of arr){
        lines.push(headers.map(h=>esc(row[h])).join(","));
      }
      return lines.join("\n");
    }
    function downloadBlob(content, filename, type="text/csv;charset=utf-8"){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }
    function downloadCSV(name){
      const map = {
        consultants: store.consultants,
        customers: store.customers,
        consultations: store.consultations,
        fund_types: store.fund_types,
        documents: store.documents,
        consultation_fund_types: store.consultation_fund_types,
        consultation_documents: store.consultation_documents,
        conversation_logs: store.conversation_logs
      };
      const data = map[name] || [];
      if(!data.length){ alert("데이터가 없습니다. 먼저 '데이터 생성'을 눌러주세요."); return; }
      downloadBlob(toCSV(data), name + ".csv");
    }
    function downloadAll(){
      const files = [
        ["consultants", store.consultants],
        ["customers", store.customers],
        ["consultations", store.consultations],
        ["fund_types", store.fund_types],
        ["documents", store.documents],
        ["consultation_fund_types", store.consultation_fund_types],
        ["consultation_documents", store.consultation_documents],
        ["conversation_logs", store.conversation_logs]
      ];
      if(!files.some(([_,arr])=>arr.length)){ alert("데이터가 없습니다. 먼저 '데이터 생성'을 눌러주세요."); return; }
      for(const [name, arr] of files){
        if(arr.length) downloadBlob(toCSV(arr), name + ".csv");
      }
    }

    // 초기 렌더
    renderTable("consultations");
  </script>
</body>
</html>